import { invalidateCompilation, isCached } from "./compile.js";
async function trackCSSDependencies(opts) {
  const { viteDevServer, filename, deps, id } = opts;
  if (viteDevServer) {
    const mod = viteDevServer.moduleGraph.getModuleById(id);
    if (mod) {
      const cssDeps = (await Promise.all(Array.from(deps).map((spec) => {
        return this.resolve(spec, id);
      }))).filter(Boolean).map((dep) => dep.id);
      const { moduleGraph } = viteDevServer;
      const depModules = new Set(mod.importedModules);
      for (const dep of cssDeps) {
        depModules.add(moduleGraph.createFileOnlyEntry(dep));
      }
      moduleGraph.updateModuleInfo(mod, depModules, new Set(), true);
      for (const dep of cssDeps) {
        this.addWatchFile(dep);
      }
    }
  }
}
function handleHotUpdate(ctx, config) {
  invalidateCompilation(config, ctx.file);
  const filtered = new Set(ctx.modules);
  const files = new Set();
  for (const mod of ctx.modules) {
    if (mod.file && isCached(config, mod.file)) {
      filtered.add(mod);
      files.add(mod.file);
    }
    for (const imp of mod.importers) {
      if (imp.file && isCached(config, imp.file)) {
        filtered.add(imp);
        files.add(imp.file);
      }
    }
  }
  for (const file of files) {
    invalidateCompilation(config, file);
  }
  return Array.from(filtered);
}
export {
  handleHotUpdate,
  trackCSSDependencies
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vc3JjL3ZpdGUtcGx1Z2luLWFzdHJvL2htci50cyJdLAogICJtYXBwaW5ncyI6ICJBQUdBO0FBU0Esb0NBQXNFLE1BQWtEO0FBQ3ZILFFBQU0sRUFBRSxlQUFlLFVBQVUsTUFBTSxPQUFPO0FBRTlDLE1BQUksZUFBZTtBQUNsQixVQUFNLE1BQU0sY0FBYyxZQUFZLGNBQWM7QUFDcEQsUUFBSSxLQUFLO0FBQ1IsWUFBTSxVQUNMLE9BQU0sUUFBUSxJQUNiLE1BQU0sS0FBSyxNQUFNLElBQUksQ0FBQyxTQUFTO0FBQzlCLGVBQU8sS0FBSyxRQUFRLE1BQU07QUFBQSxXQUkzQixPQUFPLFNBQ1AsSUFBSSxDQUFDLFFBQVMsSUFBbUI7QUFFbkMsWUFBTSxFQUFFLGdCQUFnQjtBQUd4QixZQUFNLGFBQWEsSUFBSSxJQUFJLElBQUk7QUFDL0IsaUJBQVcsT0FBTyxTQUFTO0FBQzFCLG1CQUFXLElBQUksWUFBWSxvQkFBb0I7QUFBQTtBQUloRCxrQkFBWSxpQkFBaUIsS0FBSyxZQUFZLElBQUksT0FBTztBQUN6RCxpQkFBVyxPQUFPLFNBQVM7QUFDMUIsYUFBSyxhQUFhO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFNZix5QkFBeUIsS0FBaUIsUUFBcUI7QUFFckUsd0JBQXNCLFFBQVEsSUFBSTtBQUlsQyxRQUFNLFdBQVcsSUFBSSxJQUFnQixJQUFJO0FBQ3pDLFFBQU0sUUFBUSxJQUFJO0FBQ2xCLGFBQVcsT0FBTyxJQUFJLFNBQVM7QUFDOUIsUUFBSSxJQUFJLFFBQVEsU0FBUyxRQUFRLElBQUksT0FBTztBQUMzQyxlQUFTLElBQUk7QUFDYixZQUFNLElBQUksSUFBSTtBQUFBO0FBRWYsZUFBVyxPQUFPLElBQUksV0FBVztBQUNoQyxVQUFJLElBQUksUUFBUSxTQUFTLFFBQVEsSUFBSSxPQUFPO0FBQzNDLGlCQUFTLElBQUk7QUFDYixjQUFNLElBQUksSUFBSTtBQUFBO0FBQUE7QUFBQTtBQU9qQixhQUFXLFFBQVEsT0FBTztBQUN6QiwwQkFBc0IsUUFBUTtBQUFBO0FBRy9CLFNBQU8sTUFBTSxLQUFLO0FBQUE7IiwKICAibmFtZXMiOiBbXQp9Cg==
